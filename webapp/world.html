<!DOCTYPE html>

<html lang="en" data-ng-app="worldModule">
<head>
	<title>Shelter</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-theme.css">
</head>

<body role="document" >
	<nav id="navbar" class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li class="active"><a href="shelter.html">Shelter view</a></li>
					<li><a href="world.html">World map</a></li>
				</ul>
			</div>
		</div>
	</nav>
	
	<div class="container" role="main">
		<div data-ng-controller="worldController" class="row">
		    <div class="col-xs-12 col-sm-12 col-md-12">
				<h3>
					World view
					<span class="pull-right">
			    		<button class="btn btn-xs btn-primary" data-ng-click="updateWorld()">
							<i class="glyphicon glyphicon-refresh"></i>
			    			<span class="hidden-xs">refresh world</span>
			    		</button>
			    	</span>
				</h3>
				<div class="bg-silver" data-ng-view="worldView" id="world">
					<div>
						<span data-ng-click="updateCity(city)" data-ng-repeat="city in cities | orderBy: 'name'">{{city.name}} &nbsp;</span>
					</div>
				</div>
				<hr>
				<div data-ng-if="city">
					<h4>{{city.name}} view</h4>
					<div>
						<table class="table table-striped table-hover">
							<tr data-ng-repeat="street in city.streets | orderBy: number">
								<td>Street {{street.number}}</td>
								<td data-ng-repeat="spot in street.spots | orderBy: number">{{spot.number}}:{{spot.name}}</td>
							</tr>
						</table>
					</div>
				</div>
				
			</div>
		</div>
	</div>

	<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/angular.min.js"></script>
	
	<script>
		var app = angular.module( 'worldModule', [] )
		
		app.controller('worldController', function( $scope, $interval, httpService ) {
			
			$scope.updateWorld = function() {
				httpService.getData("/world/get").then(function(world){
					$scope.cities = world.cities
				})
			}
			
			$scope.updateCity = function(city) {
				fillEmptySpot(city.streets)
				$scope.city = city
			}
			
			// add "empty spot" between reals spot,
			// use to interact with street
			function fillEmptySpot(streets) {
				var keys = Object.keys(streets)
				keys.forEach(function(key) {
					var street = streets[key]
					var spotList = Array.apply(null, {length: 10}).map(function(discard, n){ return n + 1 })
					var used = Object.keys(street.spots).map(function(v,i){
						return street.spots[v].number
					})
					spotList.forEach(function(e) {
						if($.inArray(e, used) == - 1) {
							var emptySpot = {id:-1, number:e, name:'vide'}
							street.spots[e] = emptySpot
						}
					})
				})
				return streets
			}
			
			angular.element(document).ready(function () {
				$scope.updateWorld()

				//update view with 5s interval
				$interval(function(){
					$scope.updateWorld()
				}, 5000);
		    });
		})
	</script>
	<script type="text/javascript" src="js/shelter/http-service.js"></script>
</body>
</html>
